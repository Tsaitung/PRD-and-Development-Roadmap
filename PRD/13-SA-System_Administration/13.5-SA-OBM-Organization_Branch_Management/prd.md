# Organization & Branch Management 模組 PRD 文件

## 模組資訊
- **模組代碼**: 13.5-SA-OBM
- **模組名稱**: Organization & Branch Management（組織與分支管理）
- **負責人**: 待定
- **最後更新**: 2025-08-19
- **版本**: v1.1.0

## 命名與狀態
- FR 命名: `FR-[主模組]-[子模組]-[序號]`（例：`FR-SA-OBM-001`）
- 狀態語彙（統一給自動化腳本解析）：
  - `🔴 未開始`｜`🟡 開發中`｜`✅ 完成`｜`⚪ 規劃中`

## 模組概述
管理公司組織結構（總部/HQ、營運分區、分公司據點、部門）與人員隸屬，並支援「外部加盟分區」的合約/費率設定、資料同步策略、合約到期自動處理與獨立報表權限。OBM 提供配置與主檔；結算入帳委由 FA，報表權限由 BI 執行；權限與租戶隔離由 SA-UPM 配合。此模組允許系統管理員建立並管理「總部－分區－分公司－部門」的階層關係，以及將使用者（員工）關聯至適當的部門，支援日後權限控管與資料分區查看等需求。

## 業務價值
- **以組織為軸的單一真相來源（SSOT）**：降低跨系統配置分散與錯配風險
- **與權限、財務、報表串接**：實現分區/加盟商級別的資料隔離與治理
- **支援加盟模式**：自動結算、到期控管、資料同步，降低營運成本與財務風險
- **組織清晰化**：模組使管理者能定義公司內的階層架構（總部/分公司/部門），確保組織單位與人員歸屬清晰明確
- **權限控管基礎**：透過將使用者綁定至部門與分公司，此模組為權限與資料範圍控管奠定基礎
- **營運效率提升**：區分營運分區及其下分公司有助於區域營運管理，提升決策和協作效率
- **靈活擴展**：統一的組織單位模型讓系統更易於在公司擴編時增設新分公司或部門

## 功能需求

### FR-SA-OBM-001: 分公司（含總部）資料維護
**狀態**: 🟡 開發中  
**優先級**: P0

**功能描述**:
系統需提供介面讓管理者維護公司各分支機構（包含總公司與分公司）的資料。這包括新增新的分公司紀錄、編輯現有分公司資訊，以及在必要時停用分公司（例如分公司裁撤或合併）。總公司作為最高級單位也在此功能範疇內，允許檢視與更新（但不可刪除）。此功能確保系統中的組織架構起點（總部）與各分公司據點正確且最新。

**功能需求細節**:
- **條件/觸發**: 當管理者進入「組織管理」設定頁面，選擇分公司管理功能時
- **行為**: 系統應列出所有已存在的分公司（含總部）資訊，可讓管理者新增、修改或停用分公司資料
- **資料輸入**: 新增/編輯分公司時需輸入名稱（不可與現有分公司重複）、所在地區或地址、聯絡電話、以及選擇所屬營運分區等資料
- **資料輸出**: 成功新增或更新後，新的分公司資料儲存於資料庫中，並即時反映在分公司列表。停用分公司則將其狀態標記為非活躍，但保留於資料庫以供歷史查詢
- **UI反應**: 執行新增/編輯/停用操作後，介面顯示成功訊息（例如「分公司資料已更新」），並在列表中更新該分公司的狀態（如以灰色或標註「已停用」顯示）。若有輸入錯誤，於相應欄位提示錯誤訊息
- **例外處理**: 
  - 當輸入的分公司名稱與現有重複時，系統應阻止保存並提示錯誤「名稱已存在」
  - 停用分公司時，如該分公司仍有活躍的子單位或員工隸屬，系統應提示確認或阻止，要求先處理相關隸屬關係

**用戶故事**:
作為系統管理員，我希望能夠新增或更新公司各分公司（包括總公司）的資訊，以便公司組織架構變動時可以即時在系統中反映，維持資料的正確性。

**驗收標準**:
```yaml
- 條件: 管理員提供有效的新分公司名稱與必填資訊並提交新增請求
  預期結果: 分公司成功建立，系統將新分公司顯示在列表中，狀態預設為啟用

- 條件: 管理員嘗試將分公司名稱更新為與現有分公司相同的名稱
  預期結果: 分公司更新被拒絕，系統提示錯誤訊息「分公司名稱重複」，資料庫保持原值不變

- 條件: 管理員將一個已有員工的分公司狀態設為停用
  預期結果: 系統提示需先解除該分公司下所有員工的隸屬或轉移，未經確認不允許直接停用
```

**技術需求**:
- **API 端點**: 
  - `GET /api/v1/org-units?type=branch`
  - `POST /api/v1/org-units`
  - `PUT /api/v1/org-units/{id}`
  - `PATCH /api/v1/org-units/{id}/status`
- **數據模型**: OrganizationUnit (type=BRANCH/HEADQUARTER)
- **權限要求**: 需要 system.admin 權限
- **認證方式**: JWT Token

**追蹤資訊**:
- **Tests**: `tests/unit/FR-SA-OBM-001.test.py`
- **Code**: `src/modules/system-admin/organization/**`
- **TOC**: `TOC Modules.md` [13.5-SA-OBM]

**依賴關係**:
- **依賴模組**: 13.1-SA-UPM (用戶權限管理)
- **依賴功能**: 權限驗證機制
- **外部服務**: 無

---

### FR-SA-OBM-002: 營運分區設定與管理（含外部分區旗標）
**狀態**: 🟡 開發中  
**優先級**: P1

**功能描述**:
系統應允許管理者設定「營運分區」以分組分公司。例如公司可依地理區域將分公司歸類為北區、中區、南區等。管理者可以定義新的分區類別、編輯分區名稱，以及將分公司隸屬到特定分區。此功能讓組織架構可以支援多層級分類，便利日後區域管理與查詢。分區本身作為虛擬組織單位，不涉及實體地址，但用於邏輯分類。

**功能需求細節**:
- **條件/觸發**: 管理者選擇在組織管理頁面的「營運分區管理」功能時
- **行為**: 系統提供介面列出所有已定義的分區（例如北區、南區等），允許新增或修改分區名稱，以及調整各分公司的歸屬分區
- **資料輸入**: 新增分區時需輸入分區名稱（須唯一，如「東區」），編輯時可更改名稱。將分公司指派到分區時需選擇分區名稱並挑選分公司
- **資料輸出**: 當新增或編輯分區成功後，更新的分區列表應保存於資料庫並顯示於UI。同時，分公司與分區的關係變更儲存
- **UI反應**: 成功新增分區後，在分區列表中出現新分區項目；若編輯名稱，列表即時更新顯示新名稱。拖曳或選單調整分公司歸屬分區後，界面上該分公司將顯示在新分區節點下
- **例外處理**: 
  - 若嘗試新增重複名稱的分區，系統應提示錯誤「分區名稱已存在」，不可建立
  - 若所有分公司均已歸屬某一分區，系統在嘗試刪除該分區時應提示無法刪除（需先移出或重新指派分公司）
  - 分區名稱不得為空白或無效字元，違反時前端即時驗證提示

**用戶故事**:
作為系統管理員，我希望能設定和調整各分公司的營運分區，例如將新成立的分公司歸類到「北區」或「南區」，以便按照區域彙整管理和查看營運資訊。

**驗收標準**:
```yaml
- 條件: 管理員新增一個名稱為「東區」的新營運分區
  預期結果: 系統成功建立「東區」分區，該分區出現在分區列表中，可供分公司指派

- 條件: 管理員將「台中分公司」從原本的「北區」分區調整至「中區」分區
  預期結果: 資料庫更新「台中分公司」隸屬的分區為「中區」，前端組織樹中「台中分公司」移動至「中區」節點下，並顯示成功訊息

- 條件: 管理員嘗試建立名稱為「北區」的分區，但系統中已存在同名分區
  預期結果: 新增動作被拒絕，前端提示錯誤「分區名稱已存在」，不會重複建立相同名稱的分區
```

**技術需求**:
- **API 端點**: 
  - `GET /api/v1/org-units?type=region`
  - `POST /api/v1/org-units`
  - `PUT /api/v1/org-units/{id}`
- **數據模型**: OrganizationUnit (type=REGION)
- **權限要求**: 需要 system.admin 權限

**追蹤資訊**:
- **Tests**: `tests/unit/FR-SA-OBM-002.test.py`
- **Code**: `src/modules/system-admin/organization/**`
- **TOC**: `TOC Modules.md` [13.5-SA-OBM]

---

### FR-SA-OBM-003: 部門單位管理
**狀態**: 🔴 未開始  
**優先級**: P0

**功能描述**:
提供管理者建立與維護公司各部門的功能。部門可以隸屬於總部或某一分公司。透過此功能，管理者能為每個分公司新增所屬部門（例如營運部、採購部、會計部等），以及在總部層級建立全公司共用的部門（如人資部門）。系統允許編輯部門名稱、指派/變更其所屬的分公司或總部，以及必要時停用部門。此功能確保所有使用者皆隸屬到某個部門，作為權限與人資管理的基本單位。

**功能需求細節**:
- **條件/觸發**: 管理者在組織管理頁中選取某總部或分公司節點後，選擇「新增部門」或管理現有部門時
- **行為**: 系統允許在所選單位下新增部門，或編輯部門名稱及隸屬關係。管理者可將部門歸屬改掛到不同的分公司/總部（組織調整時），也可停用不再使用的部門
- **資料輸入**: 新增部門時需輸入部門名稱（該分公司內唯一）、選擇所屬單位（總部或某分公司）。編輯時可修改名稱或所屬單位。停用部門則點選停用開關或狀態
- **資料輸出**: 成功新增部門後，該部門記錄寫入資料庫並關聯到選定的上級單位。編輯或改隸屬後，資料庫更新部門名稱或其父級單位欄位。停用部門則更新狀態標記
- **UI反應**: 新增部門後，於UI的組織樹或清單中，在對應的分公司節點下顯示該部門名稱。編輯後即時反映新的名稱或移動部門至新父節點位置。停用部門後，該部門名稱變灰並標註「已停用」
- **例外處理**: 
  - 如果在同一上級單位下新增重名的部門，系統應阻止並提示錯誤（部門名稱在同一分公司內需唯一，但不同分公司可重複）
  - 當嘗試刪除或停用仍有使用者隸屬的部門時，系統應提示警告，要求先處理該部門下的人員轉移或移除
  - 如果將部門改隸屬至另一單位，系統應同時更新所有隸屬該部門的人員的組織路徑，以免數據不一致

**用戶故事**:
作為人資管理者，我希望能夠為每個分公司新增和維護其內部的部門資訊，並在組織調整時修改部門歸屬，從而使員工的歸屬部門及上級單位在系統中保持最新且正確。

**驗收標準**:
```yaml
- 條件: 管理員在「北區分公司」下新增一個名為「業務部」的部門並提交
  預期結果: 系統成功建立該部門，資料庫中「業務部」隸屬關係指向「北區分公司」，前端組織樹於「北區分公司」節點下顯示「業務部」

- 條件: 管理員將「業務部」從「北區分公司」改隸屬到「中區分公司」並保存
  預期結果: 該部門的上級單位更新為「中區分公司」，所有原屬「業務部」的人員現在其組織路徑顯示屬於中區；前端更新組織樹位置，並顯示成功訊息

- 條件: 管理員嘗試在同一分公司內建立名稱相同的另一個部門
  預期結果: 新增操作被拒絕，前端提示「部門名稱重複」，不允許在同一上級單位下存在重名部門
```

**技術需求**:
- **API 端點**: 
  - `GET /api/v1/departments`
  - `POST /api/v1/org-units`
  - `PUT /api/v1/org-units/{id}`
  - `PATCH /api/v1/org-units/{id}/status`
- **數據模型**: OrganizationUnit (type=DEPARTMENT)
- **權限要求**: 需要 system.admin 或 hr.manager 權限

**追蹤資訊**:
- **Tests**: `tests/unit/FR-SA-OBM-003.test.py`
- **Code**: `src/modules/system-admin/organization/**`
- **TOC**: `TOC Modules.md` [13.5-SA-OBM]

**依賴關係**:
- **依賴模組**: 14-UP (用戶資料)
- **依賴功能**: 用戶部門關聯

---

### FR-SA-OBM-004: 組織單位停用與階層調整
**狀態**: 🔴 未開始  
**優先級**: P1

**功能描述**:
為支援組織架構的彈性維護，系統需提供將組織單位（分公司或部門）停用以及調整其階層位置的功能。停用功能允許在組織單位撤銷或長期閒置時保留其資料但標記為非活躍，以維護歷史紀錄。階層調整允許管理者在組織重組時，改變某單位的上級關係（例如把某部門從一個分公司移到另一個分公司，或將某分公司改歸屬不同的分區）。該功能確保組織架構可以根據實際業務需要進行調整而不需要刪除重建資料。

**功能需求細節**:
- **條件/觸發**: 當組織架構發生變動，管理者在組織管理介面選擇某一組織單位（分公司或部門）進行「停用」或「調整階層」操作時
- **行為**: 系統將選定的組織單位標記為停用（若選擇停用）或開放編輯其父級單位關係（若選擇調整階層）。對於階層調整，系統需提供當前可遷移的目標清單，並在確認後更新其父子關係
- **資料輸入**: 
  - 停用操作：需要管理者確認停用指令（例如勾選確認或輸入「CONFIRM」）
  - 調整階層操作：管理者需選擇新的上級單位（例如從下拉列表中選取新的所屬分區/分公司）
- **資料輸出**: 
  - 停用：資料庫中對應單位的狀態欄位更新為 inactive/停用。該單位不再在預設查詢中出現，但其資料仍可透過歷史查詢取得
  - 調整階層：資料庫中該單位的父級單位欄位更新為新的上級ID，該單位以及其所有下屬關係的組織路徑相應改變
- **UI反應**: 
  - 停用：前端將該單位在組織列表/樹上以停用狀態顯示或移至「已停用」區域，同時提示「已停用成功」
  - 調整階層：前端組織結構圖中，該節點移動至新位置。操作完成後彈出「階層關係已更新」通知
- **例外處理**: 
  - 若嘗試停用一個仍有子單位且未先停用子單位的分公司，系統應阻止並提示「請先停用或移除其下層單位」
  - 調整階層時，如果選擇非法的目標（例如將部門移到一個部門下或無效的組織級別），系統應禁止操作並提示無效
  - 在進行階層調整時，如果發生系統錯誤或網路中斷，系統應確保不會產生部分更新的狀態（需事務性更新）

**用戶故事**:
作為系統管理員，我希望在組織架構變動時，可以將某個分公司或部門停用或重新歸屬到新的上級單位，這樣在組織調整或部門裁撤時，系統資料能配合更新且保留歷史，不影響舊有記錄查詢。

**驗收標準**:
```yaml
- 條件: 管理員將「南區分公司」狀態設為停用並確認操作
  預期結果: 系統將「南區分公司」標記為停用，前端在組織列表不再顯示或將其歸類在「停用單位」清單中；與其相關的新交易操作被禁止

- 條件: 管理員將「研發部」從「總部」調整隸屬到「北區分公司」
  預期結果: 資料庫更新「研發部」父單位為「北區分公司」，所有屬於「研發部」的人員現在其所屬分公司變為北區分公司；前端組織樹中「研發部」移至「北區分公司」節點下並顯示成功提示

- 條件: 管理員嘗試直接停用一個仍有啟用子部門的分公司
  預期結果: 系統拒絕操作並彈出警示「尚有下屬部門未處理，請先停用或轉移所有子部門」，避免不完整的停用狀態
```

**技術需求**:
- **API 端點**: 
  - `PATCH /api/v1/org-units/{id}/status`
  - `PUT /api/v1/org-units/{id}`
- **數據模型**: OrganizationUnit (status, parent_id)
- **權限要求**: 需要 system.admin 權限
- **事務保證**: 使用資料庫事務確保一致性

**追蹤資訊**:
- **Tests**: `tests/unit/FR-SA-OBM-004.test.py`
- **Code**: `src/modules/system-admin/organization/**`
- **TOC**: `TOC Modules.md` [13.5-SA-OBM]

---

### FR-SA-OBM-005: 使用者與部門綁定管理
**狀態**: 🔴 未開始  
**優先級**: P0

**功能描述**:
系統須支援將使用者（員工帳號）綁定到部門的功能。這包括在新增或編輯使用者資訊時，指定其所屬的部門（進而對應到特定分公司與分區）。每個使用者應有唯一的主要部門隸屬，以明確其組織歸屬。當使用者部門被設定後，系統中的其他模組（如訂單、報表）可根據該資訊進行資料篩選與權限控制。此功能模組提供使用者清單中部門欄位的設定，以及批次調整使用者部門的能力。

**功能需求細節**:
- **條件/觸發**: 管理者在新增新員工帳號，或編輯現有使用者資料時，訪問「所屬部門」設定區域。也可在部門頁面直接管理該部門下的人員
- **行為**: 
  - 新增使用者時：系統要求選擇其所屬部門作為必填項
  - 編輯使用者時：允許管理者更改其所屬部門
  - 在部門管理界面：可檢視該部門下現有的所有使用者清單，並支援將某使用者移出或轉移到其他部門
- **資料輸入**: 使用者帳號的相關資料（姓名、email等）以及所屬部門（從下拉選單選取一個部門）。批量轉移時，選擇多個使用者和新部門
- **資料輸出**: 
  - 當設定或變更使用者部門後，使用者與部門的關聯資料寫入UserDepartmentMapping表
  - 變更成功後，該使用者的組織屬性更新，後續從系統查詢該使用者時會顯示新的部門/分公司資訊
  - 若使用者被移出某部門且未指派新部門，資料庫應標註該使用者目前無部門
- **UI反應**: 
  - 在使用者管理介面，選擇部門時提供下拉選單（包含「分公司 > 部門」層級顯示）。設定後按保存，若成功將彈出「使用者部門已更新」
  - 在部門詳情頁中，列出隸屬該部門的使用者，並提供移除或轉移操作按鈕。操作完成後，界面及使用者列表即時更新
- **例外處理**: 
  - 若管理者嘗試將使用者指派到一個不存在或已停用的部門，系統應阻止並提示錯誤「無效的部門選擇」
  - 若使用者正在某些進行中的流程中（例如訂單處理），其部門更改可能影響流程，系統需提示潛在影響
  - 不允許同一使用者同時綁定多於一個主部門；如需跨部門職責，需透過其他機制處理

**用戶故事**:
作為人資或 IT 管理員，我希望在新增或變更員工資料時，可以設定該員工所屬的部門，從而讓系統知道這名員工屬於哪一分公司和單位，以支援權限控管及日後根據部門/分公司篩選資料的需求。

**驗收標準**:
```yaml
- 條件: 管理員新增一個新員工帳號並選擇其所屬部門為「南區分公司 - 行銷部」後提交
  預期結果: 新員工被成功建立，UserDepartmentMapping 正確紀錄該員工ID與「行銷部」部門ID的關聯；在使用者列表中該員工的部門欄位顯示「行銷部（南區分公司）」

- 條件: 管理員將某員工的所屬部門從「南區分公司 - 行銷部」更改為「北區分公司 - 行銷部」並保存
  預期結果: 系統更新該員工的部門關聯至新的部門ID；該員工現在被視為北區分公司人員。所有以部門或分公司為條件的資料查詢結果應相應更新

- 條件: 管理員嘗試將一名員工同時指派到兩個不同部門
  預期結果: 系統阻止此操作並提示「每位使用者僅能有一個主要部門」，不會產生重複的綁定關係
```

**UI/UX 規格**:
- **頁面/路徑**: /admin/users, /admin/departments/{id}/users
- **元件規格**: 下拉選單（TreeSelect）顯示組織階層
- **狀態與互動**: 選擇部門時自動顯示完整路徑
- **無障礙**: 支援鍵盤導航和螢幕閱讀器

**資料驗證**:
- **部門ID**: UUID格式，必須存在且為活躍狀態
- **使用者ID**: 整數，必須存在於系統
- **驗證規則**: 一個使用者只能有一個當前部門
- **格式要求**: 部門選擇必須為葉節點（DEPARTMENT類型）

**技術需求**:
- **API 端點**: 
  - `GET /api/v1/departments/{deptId}/users`
  - `PATCH /api/v1/users/{userId}/department`
  - `POST /api/v1/departments/{deptId}/users`
  - `DELETE /api/v1/departments/{deptId}/users/{userId}`
- **數據模型**: UserDepartmentMapping
- **權限要求**: 需要 hr.manager 或 system.admin 權限
- **認證方式**: JWT Token

**追蹤資訊**:
- **Tests**: `tests/unit/FR-SA-OBM-005.test.py`
- **Code**: `src/modules/system-admin/organization/**`
- **TOC**: `TOC Modules.md` [13.5-SA-OBM]

**依賴關係**:
- **依賴模組**: 14-UP (用戶管理), 13.1-SA-UPM (權限管理)
- **依賴功能**: 用戶基本資料、權限驗證
- **外部服務**: 無

---

### FR-SA-OBM-006: 組織結構檢視與導覽
**狀態**: 🔴 未開始  
**優先級**: P2

**功能描述**:
系統應提供直觀的組織結構檢視介面，讓管理者可以在單一頁面看到完整的組織架構樹狀圖或清單，包括總部、各分區、分公司及部門的階層關係。此功能提供組織樹的展開/摺疊瀏覽、快速搜尋特定單位、以及從樹狀節點直接進入相應管理操作的能力。透過組織結構圖，使用者可以方便地導航至特定分公司或部門進行管理，同時清楚了解組織佈局。該介面也將顯示每個單位下的人數統計，以提供管理上的參考。

**功能需求細節**:
- **條件/觸發**: 管理者點擊「組織架構總覽」或在組織管理模組首頁時，自動呈現組織結構圖
- **行為**: 系統加載所有組織單位資料並構建階層結構，在前端以樹狀或分節列表形式展示。管理者可展開或收合各節點、查看每個單位的基本資訊。點擊某個節點可顯示該單位的詳細資訊及操作按鈕。搜尋框允許輸入部門或分公司名稱並高亮對應節點
- **資料輸入**: 無直接輸入（此為檢視功能），除了使用者操作如點擊節點或輸入搜尋關鍵字
- **資料輸出**: 系統根據資料庫中的組織單位和關聯，組裝出表示整棵組織樹的結構資料傳至前端。顯示時，每個單位節點旁輸出額外資訊如人數統計、狀態圖示等
- **UI反應**: 
  - 組織結構載入時，UI 以樹狀圖形式呈現，有不同圖示表示分區、分公司、部門等類型
  - 管理者點擊節點時，該節點展開顯示子節點，並在側邊/彈窗顯示詳細資訊和可執行操作
  - 輸入搜尋時，符合的單位名稱被高亮並自動展開所在分支
  - 若無法找到匹配單位，顯示「找不到相符的組織單位」
- **例外處理**: 
  - 若組織資料量很大導致加載緩慢，系統可實作延遲載入（lazy load）子節點，即展開時才載入該分支節點
  - 如果當前沒有建立任何組織單位，介面應顯示適當的空狀態提示「尚未設定組織架構」
  - 權限控制：非管理員角色即使進入此頁面，也只應看到其自身相關部分的結構，其他節點隱藏或不可展開

**用戶故事**:
作為系統管理員，我希望可以在一個總覽頁面直觀地看到公司完整的組織結構樹，並能方便地點擊各單位進行管理，從而提高維護組織資料的效率且不遺漏任何單位的狀態。

**驗收標準**:
```yaml
- 條件: 組織架構中包含總部、3個分區、每個分區各2個分公司及若干部門；管理員打開「組織結構總覽」頁面
  預期結果: 系統以樹狀圖完整呈現上述組織層級，管理員可展開/收合各節點，並清楚辨識總部、分區、分公司、部門的階層關係

- 條件: 管理員在組織結構總覽的搜尋框輸入「會計部」進行查找
  預期結果: 若存在名稱含「會計部」的單位，系統自動展開對應路徑並高亮該部門節點；頁面聚焦到該位置方便管理員操作

- 條件: 分公司經理帳號登入並開啟組織結構檢視頁
  預期結果: 系統僅顯示該經理所屬分公司的組織分支，而不顯示其他分區/分公司的資訊；經理可以看到其分公司下的部門結構，但無法展開或查看不屬於他的部分
```

**UI/UX 規格**:
- **頁面/路徑**: /admin/organization/overview
- **元件規格**: TreeView 元件（支援展開/收合、拖放）
- **狀態與互動**: 
  - 節點展開箭頭動畫過渡
  - 滑鼠懸停顯示快速操作按鈕
  - 支援右鍵選單操作
- **無障礙**: ARIA tree role，支援鍵盤導航（上下左右鍵）

**技術需求**:
- **API 端點**: 
  - `GET /api/v1/org-units/tree`
  - `GET /api/v1/org-units/search?q={keyword}`
- **數據模型**: OrganizationUnit (樹狀結構)
- **權限要求**: 根據用戶權限過濾可見節點
- **效能優化**: 支援懶加載和虛擬滾動

**追蹤資訊**:
- **Tests**: `tests/unit/FR-SA-OBM-006.test.py`
- **Code**: `src/modules/system-admin/organization/**`
- **TOC**: `TOC Modules.md` [13.5-SA-OBM]

---

### FR-SA-OBM-007: 加盟合約主檔與費率/權利金設定（配置）
**狀態**: 🔴 未開始  
**優先級**: P0

**功能描述**:
針對 is_external 分區，建立「加盟合約」主檔：起迄日、幣別、結算週期(月/季)、費率/權利金規則、最低保證、稅率/發票資訊、入帳科目映射（交由 FA 使用），以及銀行收付資料。

**功能需求細節**:
- **條件/觸發**: 分區 is_external=true
- **行為**: 建立/編輯/版本化合約；禁止覆蓋重疊期間
- **資料輸入**: 
  - region_id
  - period: start_date, end_date, grace_days
  - currency, tax_profile, invoice_profile
  - fee_rules: platform_fee (PERCENT|FLAT|TIERED), royalty, per_order_fee, min_guarantee
  - settlement_cycle: MONTHLY|QUARTERLY, cutoff_day
  - fa_mapping: ar_account, ap_account, revenue_account, fee_account, tax_account
  - bank_info_ref
- **資料輸出**: 合約記錄（版本號、狀態）
- **UI反應**: 合約表單（包含規則預覽/試算）、版本列表與比較
- **例外處理**: 
  - 與既有有效期間重疊 → 拒絕
  - 缺少關鍵欄位（幣別/科目/稅）→ 拒絕
  - 幣別與區域政策不符 → 警示

**用戶故事**:
作為 HQ，我要為外部分區設定合約與費率，供自動結算使用。

**驗收標準**:
```yaml
- 條件: 期間不重疊、欄位完整
  預期結果: 合約建立成功且版本=1

- 條件: 編輯生效中合約
  預期結果: 產生新版本，舊版本保留

- 條件: 缺少稅/科目映射
  預期結果: 拒絕並提示必填
```

**技術需求**:
- **API 端點**: 
  - `GET /api/v1/partners/{regionId}/contracts`
  - `POST /api/v1/partners/{regionId}/contracts`
- **數據模型**: PartnerContract
- **權限要求**: 需要 system.admin 權限

**追蹤資訊**:
- **Tests**: `tests/unit/FR-SA-OBM-007.test.py`
- **Code**: `src/modules/system-admin/organization/contracts/**`
- **TOC**: `TOC Modules.md` [13.5-SA-OBM]

**依賴關係**:
- **依賴模組**: 11-FA (財務會計)
- **依賴功能**: 科目映射、稅務設定
- **外部服務**: 無

---

### FR-SA-OBM-008: 自動結算機制（手續費/權利金）與入帳交付
**狀態**: 🔴 未開始  
**優先級**: P0

**功能描述**:
依合約規則按週期自動計算加盟分區應收/應付：平台費、權利金、每筆手續費、最低保證補差，生成「結算單」與明細，並交付 FA 建立 AR/AP/Revenue 等分錄（OBM 不直接記帳）。

**功能需求細節**:
- **條件/觸發**: 預排批次(排程)或手動觸發；僅對 is_external 分區
- **行為**: 
  - 期間交易彙總（訂單、退貨、折讓、稅），按合約規則計算
  - 生成結算單(Statement) DRAFT → REVIEW → POSTED
  - POSTED 後鎖定，吐出給 FA 的憑證/接口檔
- **資料輸入**: 
  - period: from_date, to_date
  - region_ids（選填）
  - rerun_policy: REBUILD|ADJUST
- **資料輸出**: 
  - settlement_statement: header + lines + totals
  - export_for_FA: journal_payload 或中介檔
- **UI反應**: 結算面板（期間、狀態、差異/調整、試算、重算、發佈）
- **例外處理**: 
  - 資料不一致（缺單/重複）→ 顯示差異報表與待修清單
  - 計算結果為負/超閾值 → 需人工覆核才能 POST
  - POSTED 後禁止更改（需作調整單）

**用戶故事**:
作為財務與營運，我要定期自動生成加盟結算並交付入帳。

**驗收標準**:
```yaml
- 條件: 正常期間交易齊全
  預期結果: 產生 DRAFT 結算單與正確金額

- 條件: 金額超出風險閾值
  預期結果: 標記需覆核，未覆核不可 POST

- 條件: POST 後重跑
  預期結果: 被拒絕或產生「調整單」流程
```

**技術需求**:
- **API 端點**: 
  - `POST /api/v1/partners/settlements/run`
  - `GET /api/v1/partners/settlements/{id}`
  - `POST /api/v1/partners/settlements/{id}/post`
- **數據模型**: SettlementStatement, SettlementLine
- **權限要求**: 需要 finance.manager 或 system.admin 權限

**追蹤資訊**:
- **Tests**: `tests/unit/FR-SA-OBM-008.test.py`
- **Code**: `src/modules/system-admin/organization/settlements/**`
- **TOC**: `TOC Modules.md` [13.5-SA-OBM]

**依賴關係**:
- **依賴模組**: 06-OM (訂單), 11-FA (財務), 08-WMS (退貨)
- **依賴功能**: 交易資料彙總、財務分錄
- **外部服務**: 無

---

### FR-SA-OBM-009: 資料同步策略（主檔單向、交易雙向）與連接設定
**狀態**: 🔴 未開始  
**優先級**: P1

**功能描述**:
於分區層級設定資料同步策略：主檔（品項/客戶/價表等）由 HQ → 外部單向；交易（訂單/出貨/退貨）雙向。設定外部 API/Webhook/SFTP 端點、映射與重試/死信佇列。

**功能需求細節**:
- **條件/觸發**: is_external 分區開啟「整合設定」
- **行為**: 
  - 設定 allowed_entities: { master_one_way, txn_two_way }
  - 設定 endpoints: inbound/outbound、認證、密鑰
  - 映射：欄位對映/轉換、幣別/稅碼對映
  - 可靠性：重試策略、DLQ、冪等鍵
  - 對帳：每日/每期自動對帳報表
- **資料輸入**: 
  - endpoints: [{category, direction, url, auth_type, credential_ref, active}]
  - mapping: [{entity, field_map, transform}]
  - retry_policy: {max_attempts, backoff}
  - idempotency_keys: [{entity, keys}]
- **資料輸出**: 
  - sync_policy 設定檔
  - 健康檢查/最近同步狀態
- **UI反應**: 「整合」分頁：端點、映射、健康狀態、對帳報告
- **例外處理**: 
  - 端點驗證失敗 → 不可啟用
  - 對映不完整 → 警示且禁止啟用

**用戶故事**:
作為整合工程師，我要以租戶級設定完成對接且可監控。

**驗收標準**:
```yaml
- 條件: 端點驗證通過、映射完整
  預期結果: 可啟用並開始同步

- 條件: 同步失敗達上限
  預期結果: 進 DLQ 並告警；可人工重送

- 條件: 對帳差異
  預期結果: 生成差異清單供調整
```

**技術需求**:
- **API 端點**: 
  - `POST /api/v1/partners/{regionId}/integrations/endpoints`
  - `PUT /api/v1/partners/{regionId}/integrations/policy`
- **數據模型**: IntegrationEndpoint, DataSyncPolicy
- **權限要求**: 需要 integration.admin 權限

**追蹤資訊**:
- **Tests**: `tests/unit/FR-SA-OBM-009.test.py`
- **Code**: `src/modules/system-admin/organization/integration/**`
- **TOC**: `TOC Modules.md` [13.5-SA-OBM]

**依賴關係**:
- **依賴模組**: 所有交易相關模組
- **依賴功能**: 資料匯入/匯出、對帳機制
- **外部服務**: 加盟商 API/Webhook/SFTP

---

### FR-SA-OBM-010: 合約到期自動處理（凍結/寬限/續約）
**狀態**: 🔴 未開始  
**優先級**: P0

**功能描述**:
於合約到期前 T-90/60/30/7/1 發送預警；到期自動依策略執行：凍結新交易、僅允許結清、進入寬限期 N 天後強制停用；續約則自動切換至新版本。

**功能需求細節**:
- **條件/觸發**: 排程掃描所有有效合約
- **行為**: 
  - 通知：Email/站內/Webhook
  - 到期日觸發策略：FREEZE_NEW|READ_ONLY|SHUTDOWN_AFTER_GRACE
  - 續約：新版本 start_date 無縫接續
- **資料輸入**: contract.policy: {on_expire, grace_days}
- **資料輸出**: 
  - 狀態變更：region_operability flags
  - 審計日誌
- **UI反應**: 合約時間軸、提醒設定、當前狀態旗標
- **例外處理**: 存在未結清結算單 → 僅允許結清/出清

**用戶故事**:
作為法遵與營運，我要在到期自動控管風險並提供續約銜接。

**驗收標準**:
```yaml
- 條件: T-30 發送預警
  預期結果: 指定收件人收到通知

- 條件: 到期且策略=FREEZE_NEW
  預期結果: 新訂單 API 被拒絕（403/業務代碼）

- 條件: 有新版本合約同日生效
  預期結果: 自動切換至新版本並解除凍結
```

**技術需求**:
- **API 端點**: 內部排程任務，無對外 API
- **數據模型**: PartnerContract (status, policy)
- **權限要求**: 系統排程執行

**追蹤資訊**:
- **Tests**: `tests/unit/FR-SA-OBM-010.test.py`
- **Code**: `src/modules/system-admin/organization/scheduler/**`
- **TOC**: `TOC Modules.md` [13.5-SA-OBM]

**依賴關係**:
- **依賴模組**: 01.2-DSH-NC (通知中心)
- **依賴功能**: 通知發送、排程任務
- **外部服務**: Email/Webhook 服務

---

### FR-SA-OBM-011: 獨立報表權限（RLS 租戶隔離與 HQ 彙總）
**狀態**: 🔴 未開始  
**優先級**: P0

**功能描述**:
為外部分區設定報表資料範圍（租戶/分區級 RLS），OBM 輸出報表作用域定義供 BI 套用；HQ 可見全局彙總，外部僅見自身租戶。

**功能需求細節**:
- **條件/觸發**: is_external 分區建立
- **行為**: 
  - 定義 report_scope: { tenant_id, region_ids, datasets }
  - 匯出 RLS/ACL 配置給 BI（API/配置檔）
- **資料輸入**: datasets, scopes, roles
- **資料輸出**: rls_payload 給 BI
- **UI反應**: 報表權限設定頁（測試視圖）
- **例外處理**: 未關聯 tenant_id → 禁止啟用

**用戶故事**:
作為資料治理，我要保證外部只能看到自己的數據。

**驗收標準**:
```yaml
- 條件: 外部使用者查詢報表
  預期結果: 僅返回自身租戶資料

- 條件: HQ 查詢
  預期結果: 返回全公司含外部匯總
```

**技術需求**:
- **API 端點**: 
  - `GET /api/v1/partners/{regionId}/reports/scope`
- **數據模型**: 報表權限設定
- **權限要求**: 需要 system.admin 權限

**追蹤資訊**:
- **Tests**: `tests/unit/FR-SA-OBM-011.test.py`
- **Code**: `src/modules/system-admin/organization/rls/**`
- **TOC**: `TOC Modules.md` [13.5-SA-OBM]

**依賴關係**:
- **依賴模組**: 12-BI (商業智慧), 13.1-SA-UPM (權限管理)
- **依賴功能**: RLS 機制、報表權限
- **外部服務**: BI 報表平台

## 非功能需求

### 性能需求
- 響應時間：常態操作（如查詢組織樹、指派使用者）應在 500ms 以內完成
- 組織單位資料加載：在 1000 筆以內時前端渲染不超過 2 秒
- 批量操作：批次轉移部門的多人員需在 5 秒內完成
- 並發支援：支援 100 個並發管理操作

### 安全需求
- 認證方式：JWT Token
- 授權模型：RBAC（基於角色的訪問控制）
- 數據加密：敏感資料使用 AES-256 加密
- 防護措施：SQL 注入防護、XSS 防護、CSRF Token
- 審計日誌：所有組織變更操作需記錄操作者、時間、內容

### 可用性需求
- 系統可用性：99.9%
- 災難恢復：RPO < 1小時，RTO < 4小時
- 介面支援：響應式設計，支援桌面、平板、手機
- 瀏覽器相容：Chrome 90+, Firefox 88+, Safari 14+, Edge 90+

### 擴展性需求
- 水平擴展：支援負載平衡和分散式部署
- 資料庫優化：使用索引和快取機制
- 未來擴充：預留事業部、科組等新層級的擴充空間

## 數據模型

### 主要實體

```typescript
interface OrganizationUnit {
  id: string;                    // UUID
  name: string;                   // 單位名稱
  type: 'HEADQUARTER' | 'REGION' | 'BRANCH' | 'DEPARTMENT';  // 單位類型
  parent_id?: string;             // 父級單位ID
  address?: string;               // 地址（分公司使用）
  contact_phone?: string;         // 聯絡電話（分公司使用）
  manager_id?: string;            // 負責人ID（部門使用）
  status: 'active' | 'inactive';  // 狀態
  metadata?: Record<string, any>; // 額外資訊
  created_at: Date;
  updated_at: Date;
}

interface UserDepartmentMapping {
  id: string;
  user_id: string;        // 使用者ID
  department_id: string;  // 部門ID（OrganizationUnit.id where type='DEPARTMENT'）
  assigned_at: Date;      // 指派時間
  ended_at?: Date;        // 結束時間（用於歷史記錄）
  is_primary: boolean;    // 是否為主要部門
  created_at: Date;
  updated_at: Date;
}
```

### 資料庫結構

```sql
-- 組織單位表
CREATE TABLE organization_units (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL,
  type VARCHAR(20) NOT NULL CHECK (type IN ('HEADQUARTER', 'REGION', 'BRANCH', 'DEPARTMENT')),
  parent_id UUID REFERENCES organization_units(id),
  address TEXT,
  contact_phone VARCHAR(50),
  manager_id UUID REFERENCES users(id),
  status VARCHAR(20) NOT NULL DEFAULT 'active',
  metadata JSONB,
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
  
  -- 約束
  CONSTRAINT unique_name_per_parent UNIQUE(parent_id, name),
  -- 索引
  INDEX idx_parent_id (parent_id),
  INDEX idx_type (type),
  INDEX idx_status (status)
);

-- 使用者部門對照表
CREATE TABLE user_department_mappings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  department_id UUID NOT NULL REFERENCES organization_units(id),
  assigned_at TIMESTAMP NOT NULL DEFAULT NOW(),
  ended_at TIMESTAMP,
  is_primary BOOLEAN NOT NULL DEFAULT true,
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
  
  -- 約束：一個使用者同時只能有一個主要部門
  CONSTRAINT unique_primary_dept UNIQUE(user_id, is_primary) WHERE is_primary = true AND ended_at IS NULL,
  -- 索引
  INDEX idx_user_id (user_id),
  INDEX idx_department_id (department_id),
  INDEX idx_active_mapping (user_id, ended_at)
);
```

## API 設計

### API 端點列表

| 方法 | 端點 | 描述 | 狀態 |
|------|------|------|------|
| GET | `/api/v1/org-units?type=branch` | 獲取所有分公司（包含總部）列表 | 🔴 未開始 |
| GET | `/api/v1/org-units/:id` | 獲取特定組織單位詳情 | 🔴 未開始 |
| POST | `/api/v1/org-units` | 新增組織單位 | 🔴 未開始 |
| PUT | `/api/v1/org-units/:id` | 更新指定組織單位資訊 | 🔴 未開始 |
| DELETE | `/api/v1/org-units/:id` | 刪除指定組織單位 | 🔴 未開始 |
| PATCH | `/api/v1/org-units/:id/status` | 停用或啟用指定組織單位 | 🔴 未開始 |
| GET | `/api/v1/org-units/tree` | 以樹狀結構取得完整組織架構資料 | 🔴 未開始 |
| GET | `/api/v1/departments/:deptId/users` | 取得指定部門下的所有使用者清單 | 🔴 未開始 |
| PATCH | `/api/v1/users/:userId/department` | 調整指定使用者的所屬部門 | 🔴 未開始 |

### 請求/響應範例

```json
// 範例：建立新分公司
// POST /api/v1/org-units
{
  "name": "東區分公司",
  "type": "BRANCH",
  "parentId": "11111111-2222-3333-4444-555555555555",
  "address": "台東市中正路100號",
  "contactPhone": "08-1234-5678"
}

// 成功回應
// HTTP/1.1 201 Created
{
  "success": true,
  "data": {
    "id": "6f8c9d34-5678-9012-3456-789012345678",
    "name": "東區分公司",
    "type": "BRANCH",
    "parentId": "11111111-2222-3333-4444-555555555555",
    "address": "台東市中正路100號",
    "contactPhone": "08-1234-5678",
    "status": "active",
    "createdAt": "2025-09-01T08:00:00Z"
  }
}

// 範例：更新使用者部門
// PATCH /api/v1/users/12345/department
{
  "departmentId": "aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee"
}

// 成功回應
// HTTP/1.1 200 OK
{
  "success": true,
  "message": "User department updated",
  "data": {
    "userId": "12345",
    "newDepartmentId": "aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee",
    "oldDepartmentId": "ffffffff-gggg-hhhh-iiii-jjjjjjjjjjjj"
  }
}
```

## UI/UX 設計

### 頁面流程
1. 從主選單進入「系統管理」(System Administration) 模組
2. 點選「組織/分支管理」選項，進入本模組首頁
3. 首頁呈現組織結構總覽（樹狀圖）及各主要操作入口
4. 點擊節點進行新增/編輯/刪除操作，或查看詳細資訊

### 主要畫面
- **組織架構總覽**: 
  - 左側為樹狀組織圖
  - 右側為選中節點的詳細資訊面板
  - 使用不同圖示表示：🏢 公司/分公司、📂 部門、🌍 分區
  - 節點顯示名稱和人數統計

- **分公司/部門表單**: 
  - Modal 對話框形式
  - 包含必填欄位標記
  - 即時驗證提示
  - 確認和取消按鈕

- **使用者清單**: 
  - 表格形式顯示部門人員
  - 支援排序和篩選
  - 批量操作功能

### 互動設計
- 節點展開/收合動畫
- 拖放調整組織關係
- 右鍵快捷選單
- 搜尋高亮和自動定位
- 操作確認對話框

## 測試計畫

### 單元測試
- [ ] 測試組織單位新增功能
- [ ] 測試組織單位更新功能
- [ ] 測試停用單位功能
- [ ] 測試使用者部門綁定
- [ ] 測試階層查詢功能
- [ ] 測試驗證規則

### 整合測試
- [ ] 測試新增分公司流程
- [ ] 測試組織架構調整流程
- [ ] 測試使用者部門變更影響
- [ ] 測試權限隔離功能
- [ ] 測試錯誤處理流程

### 驗收測試
- [ ] 場景1：新增組織單位與人員
- [ ] 場景2：調整組織架構
- [ ] 場景3：權限驗證

## 實施計畫

### 開發階段
| 階段 | 時程 | 交付物 |
|------|------|--------|
| 階段1：詳細設計 | Week 1-2 | 系統設計文件、資料模型定義、API 規格書 |
| 階段2：後端開發 | Week 3-5 | 資料表建置、後端API實作、單元測試 |
| 階段3：前端開發 | Week 6-7 | 前端介面開發、API串接、前端測試 |
| 階段4：整合測試 | Week 8 | 功能聯調、整合測試、Bug修復 |
| 階段5：用戶驗收 | Week 9 | UAT測試、需求確認 |
| 階段6：部署 | Week 10 | 生產環境部署、資料遷移 |

### 里程碑
- [ ] M1：設計審查完成 - 2025-09-15
- [ ] M2：開發完成 - 2025-10-20
- [ ] M3：測試完成 - 2025-10-30
- [ ] M4：正式上線 - 2025-11-05

## 風險評估

### 技術風險
| 風險 | 影響 | 機率 | 緩解措施 |
|------|------|------|----------|
| 組織階層查詢性能問題 | 中 | 中 | 實作遞迴SQL優化，引入快取機制 |
| 資料一致性與併發修改 | 高 | 低 | 使用事務和樂觀鎖定 |
| 權限控管錯誤 | 高 | 低 | 充分測試RBAC設定，審計日誌 |
| 資料遷移風險 | 中 | 中 | 多次演練，雙寫過渡方案 |

### 業務風險
| 風險 | 影響 | 機率 | 緩解措施 |
|------|------|------|----------|
| 組織調整頻繁 | 中 | 中 | 提供批次操作工具和培訓 |
| 設定錯誤影響業務 | 高 | 低 | 雙人複核，變更警告 |
| 人員不熟悉新系統 | 中 | 中 | 培訓說明，專人支持 |
| 模組延後上線 | 中 | 低 | 明確優先級，臨時方案 |

## 相關文件
- [系統架構文件](../docs/architecture.md)
- [API 文件](../docs/api.md)
- [測試文件](../docs/testing.md)
- [資料庫設計文件](../docs/database.md)

## 變更記錄
| 版本 | 日期 | 變更內容 | 變更人 |
|------|------|----------|--------|
| v1.0.0 | 2025-08-18 | 初始版本創建 | Claude Code |

---

**文件狀態**: 草稿  
**下次審查日期**: 2025-09-01