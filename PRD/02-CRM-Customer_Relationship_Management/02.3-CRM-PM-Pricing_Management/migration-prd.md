# 【舊系統轉移】CRM-PM 價格管理模組 PRD

## 轉移資訊
- **來源系統**: tsaitung-dashboard-central (北區)
- **原始頁面**: 
  - `/pricetable/` - 價格表管理
  - `/reprice/` - 時價回填
- **原始代碼位置**: 
  - `/libs/tsaitung-dashboard/PriceTable/`
  - `/libs/tsaitung-dashboard/Reprice/`
- **轉移類型**: 功能保留型轉移
- **轉移優先級**: P1-高
- **最後更新**: 2025-08-20

## 模組資訊
- **模組代碼**: CRM-PM
- **模組名稱**: 價格配置管理 (Pricing Management)
- **負責人**: [待指派]
- **版本**: v1.0.0-migration

## 模組概述
價格管理模組負責管理客戶的產品價格設定，包含基礎價格表、客戶專屬價格、時價商品回填等功能。支援多層級價格策略、批量價格調整、價格有效期管理等核心定價功能。

## 舊系統功能分析

### 現有功能清單

#### 價格表管理 (pricetable)
1. **價格表查詢**
   - 依客戶搜尋價格表
   - 依商品搜尋價格
   - 價格有效期篩選

2. **價格設定**
   - 基礎價格設定
   - 客戶專屬價格
   - 批量價格調整
   - 價格生效日期設定

3. **價格層級**
   - 企業級價格
   - 公司級價格
   - 門市級價格
   - 優先級判斷邏輯

#### 時價回填 (reprice)
1. **時價商品管理**
   - 時價商品清單
   - 每日價格更新
   - 歷史價格查詢

2. **價格回填**
   - 批量回填功能
   - 指定日期回填
   - 價格變動通知

### 保留與改進

#### 需保留功能
- 多層級價格體系
- 價格有效期管理
- 時價商品回填機制
- 價格歷史記錄
- 批量操作功能

#### 計劃改進項目
- 價格審批流程
- 自動定價規則引擎
- 競爭對手價格比較
- 價格異常預警
- Excel批量匯入優化
- 價格變動影響分析

## 功能需求

### FR-CRM-PM-001: 價格表查詢管理
**狀態**: 🟡 開發中
**優先級**: P1

**功能描述**:
提供價格表的查詢、檢視功能，支援多維度搜尋和篩選，快速定位特定客戶或商品的價格資訊。

**功能需求細節**:
- **條件/觸發**: 用戶進入價格表頁面或輸入搜尋條件
- **行為**: 系統查詢並顯示符合條件的價格資料
- **資料輸入**: 
  - 客戶名稱/代碼
  - 商品名稱/代碼
  - 價格生效日期範圍
  - 價格類型（基礎/特殊）
- **資料輸出**: 價格列表（含商品、價格、有效期、優先級）
- **UI反應**: 表格顯示、支援排序和分頁
- **例外處理**: 無價格資料時顯示預設價格

**驗收標準**:
```yaml
- 條件: 選擇特定客戶
  預期結果: 顯示該客戶所有商品價格
  
- 條件: 搜尋特定商品
  預期結果: 顯示所有客戶對該商品的價格
  
- 條件: 設定日期範圍
  預期結果: 只顯示該期間有效的價格
```

**技術需求**:
- **API 端點**: `GET /api/v1/pricing/search`
- **請求參數**:
  ```json
  {
    "customer_id": "string",
    "product_id": "string",
    "effective_date": "YYYY-MM-DD",
    "price_type": "base|special|promotional"
  }
  ```

### FR-CRM-PM-002: 客戶價格設定
**狀態**: 🟡 開發中
**優先級**: P1

**功能描述**:
設定和維護客戶專屬價格，支援單一設定和批量設定，包含價格生效日期和優先級管理。

**功能需求細節**:
- **條件/觸發**: 用戶新增或編輯客戶價格
- **行為**: 建立或更新客戶商品價格
- **資料輸入**: 
  - 客戶（企業/公司/門市）
  - 商品清單
  - 價格（單價/折扣率）
  - 生效日期
  - 失效日期
  - 優先級
- **資料輸出**: 儲存的價格設定
- **UI反應**: 批量編輯介面、價格預覽
- **例外處理**: 價格衝突警告、日期重疊檢查

### FR-CRM-PM-003: 時價商品回填
**狀態**: 🔴 未開始
**優先級**: P1

**功能描述**:
管理時價商品的每日價格更新，支援批量回填和歷史價格追溯。

**功能需求細節**:
- **條件/觸發**: 每日定時或手動觸發
- **行為**: 更新時價商品的當日價格
- **資料輸入**: 
  - 商品清單
  - 回填日期
  - 新價格資料
  - 價格來源
- **資料輸出**: 更新後的價格記錄
- **UI反應**: 回填進度顯示、結果報告
- **例外處理**: 異常價格提醒、回填失敗重試

**驗收標準**:
```yaml
- 條件: 執行每日回填
  預期結果: 所有時價商品價格更新為最新
  
- 條件: 指定歷史日期回填
  預期結果: 該日期的訂單價格被正確更新
```

### FR-CRM-PM-004: 價格批量調整
**狀態**: 🔴 未開始
**優先級**: P2

**功能描述**:
提供批量調整價格的功能，支援按百分比、固定金額等方式調整。

**功能需求細節**:
- **條件/觸發**: 選擇批量調整功能
- **行為**: 批量更新選定範圍的價格
- **資料輸入**: 
  - 調整範圍（客戶/商品/類別）
  - 調整方式（百分比/固定金額）
  - 調整幅度
  - 生效日期
- **資料輸出**: 調整後的價格清單
- **UI反應**: 調整預覽、確認對話框
- **例外處理**: 價格下限檢查、審批流程

### FR-CRM-PM-005: 價格審批流程
**狀態**: ⚪ 規劃中
**優先級**: P2

**功能描述**:
建立價格變更的審批機制，確保價格調整的合規性。

**功能需求細節**:
- **條件/觸發**: 價格變更超過閾值
- **行為**: 觸發審批流程
- **資料輸入**: 
  - 價格變更申請
  - 變更原因
  - 影響分析
- **資料輸出**: 審批結果
- **UI反應**: 審批狀態顯示、通知
- **例外處理**: 逾時自動處理、駁回重申請

### FR-CRM-PM-006: 價格歷史追蹤
**狀態**: 🔴 未開始
**優先級**: P3

**功能描述**:
記錄和查詢價格變動歷史，提供價格趨勢分析。

**功能需求細節**:
- **條件/觸發**: 查詢價格歷史
- **行為**: 顯示價格變動記錄
- **資料輸入**: 
  - 查詢條件（客戶/商品/期間）
- **資料輸出**: 價格變動時間軸
- **UI反應**: 圖表顯示、詳細列表
- **例外處理**: 資料缺失處理

## 數據模型

### 主要實體
```typescript
// 價格表實體
interface PriceTable {
  price_id: string;
  customer_id: string;
  customer_type: 'enterprise' | 'company' | 'store';
  product_id: string;
  price: number;
  discount_rate?: number;
  price_type: 'base' | 'special' | 'promotional';
  effective_date: Date;
  expiry_date?: Date;
  priority: number;
  status: 'active' | 'pending' | 'expired';
  created_by: string;
  created_at: Date;
  updated_at: Date;
}

// 時價商品實體
interface MarketPriceItem {
  item_id: string;
  product_id: string;
  product_name: string;
  date: Date;
  market_price: number;
  source: string;
  status: 'pending' | 'confirmed' | 'applied';
  applied_orders?: string[];
  created_at: Date;
  updated_by: string;
}

// 價格歷史實體
interface PriceHistory {
  history_id: string;
  price_id: string;
  old_price: number;
  new_price: number;
  change_reason: string;
  changed_by: string;
  changed_at: Date;
  approval_status?: string;
  approved_by?: string;
}
```

## 數據遷移策略

### 遷移方式
- **策略**: 並行運行後切換
- **階段**: 
  1. 第一階段：遷移基礎價格表（1週）
  2. 第二階段：遷移客戶特殊價格（1週）
  3. 第三階段：遷移時價資料和歷史（3天）
  4. 第四階段：驗證和切換（3天）

### 數據映射
| 舊系統欄位 | 新系統欄位 | 轉換規則 |
|-----------|-----------|----------|
| price_set_id | price_table_id | 重新編碼 |
| client_id | customer_id | 統一客戶ID |
| item_code | product_id | 商品代碼映射 |
| unit_price | price | 直接映射 |
| start_date | effective_date | 日期格式轉換 |

### 相容性處理
- 保留舊價格表ID參照
- 雙系統同步期間價格一致性檢查
- 提供價格差異報告

## API 設計

### API 端點列表
| 方法 | 端點 | 描述 | 狀態 |
|------|------|------|------|
| GET | `/api/v1/pricing/search` | 搜尋價格 | 🟡 開發中 |
| GET | `/api/v1/pricing/{id}` | 獲取價格詳情 | 🔴 未開始 |
| POST | `/api/v1/pricing` | 新增價格 | 🔴 未開始 |
| PUT | `/api/v1/pricing/{id}` | 更新價格 | 🔴 未開始 |
| POST | `/api/v1/pricing/bulk` | 批量設定價格 | 🔴 未開始 |
| POST | `/api/v1/pricing/reprice` | 時價回填 | 🔴 未開始 |
| GET | `/api/v1/pricing/history` | 價格歷史 | 🔴 未開始 |

### 請求/響應範例
```json
// POST /api/v1/pricing
{
  "customer_id": "CUS_001",
  "items": [
    {
      "product_id": "PROD_001",
      "price": 100,
      "discount_rate": 0.95,
      "effective_date": "2025-08-20",
      "expiry_date": "2025-12-31"
    }
  ]
}

// Response
{
  "success": true,
  "data": {
    "created": 5,
    "updated": 2,
    "failed": 0
  }
}
```

## 測試需求

### 單元測試
- [ ] 價格優先級邏輯測試
- [ ] 日期有效性驗證測試
- [ ] 批量操作測試
- [ ] 價格計算測試

### 整合測試
- [ ] 完整定價流程測試
- [ ] 時價回填流程測試
- [ ] 價格審批流程測試
- [ ] 新舊系統資料同步測試

### 驗收測試
- [ ] 場景1：設定客戶專屬價格並驗證生效
- [ ] 場景2：執行時價回填並檢查訂單更新
- [ ] 場景3：批量調整價格並確認審批流程

## 實施計畫

### 開發階段
| 階段 | 時程 | 交付物 |
|------|------|--------|
| 階段1：基礎功能 | Week 1-2 | 價格查詢、基本CRUD |
| 階段2：批量功能 | Week 3 | 批量設定、批量調整 |
| 階段3：時價功能 | Week 4 | 時價回填、歷史追蹤 |
| 階段4：進階功能 | Week 5 | 審批流程、分析報表 |
| 階段5：測試優化 | Week 6 | 完整測試、效能優化 |

## 風險評估

### 技術風險
| 風險 | 影響 | 機率 | 緩解措施 |
|------|------|------|----------|
| 價格計算錯誤 | 高 | 低 | 完整測試、雙重驗證 |
| 資料遷移不一致 | 高 | 中 | 分階段遷移、對帳機制 |
| 效能瓶頸 | 中 | 中 | 快取機制、資料庫優化 |
| 時價回填延遲 | 中 | 低 | 非同步處理、重試機制 |

### 業務風險
| 風險 | 影響 | 機率 | 緩解措施 |
|------|------|------|----------|
| 價格設定錯誤影響營收 | 高 | 低 | 審批機制、異常預警 |
| 客戶價格爭議 | 中 | 中 | 價格歷史追蹤、變更通知 |

## 非功能需求

### 性能需求
- 價格查詢響應時間 < 1秒
- 批量設定處理 1000筆 < 10秒
- 時價回填 10000筆 < 5分鐘

### 安全需求
- 價格修改需要權限控制
- 敏感價格資料加密
- 操作日誌完整記錄

### 可用性需求
- 系統可用性 99.9%
- 價格查詢服務24/7運行
- 支援10000個並發查詢

## 相關文件
- [舊系統PriceTable代碼](https://github.com/Tsaitung/tsaitung-mono/tree/main/libs/tsaitung-dashboard/PriceTable)
- [舊系統Reprice代碼](https://github.com/Tsaitung/tsaitung-mono/tree/main/libs/tsaitung-dashboard/Reprice)
- [CRM模組架構文件](../README.md)
- [定價策略文件](../../docs/pricing-strategy.md)

## 變更記錄
| 版本 | 日期 | 變更內容 | 變更人 |
|------|------|----------|--------|
| v1.0.0-migration | 2025-08-20 | 初始轉移版本 | System |

---

**文件狀態**: 審查中
**下次審查日期**: 2025-09-01