name: MPM Automation Pipeline

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'PRD/**'
      - 'docs/**'
      - 'tests/**'
      - 'src/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'PRD/**'
      - 'docs/**'
      - 'tests/**'
      - 'src/**'
  schedule:
    # æ¯å¤©å‡Œæ™¨ 2 é»åŸ·è¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  analyze-prd:
    name: åˆ†æ PRD æ–‡ä»¶ç‹€æ…‹
    runs-on: ubuntu-latest
    outputs:
      prd-status: ${{ steps.parse-prd.outputs.status }}
      fr-ids: ${{ steps.parse-prd.outputs.fr-ids }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm install -g markdownlint-cli
        npm install -g yaml
        npm install -g js-yaml
    
    - name: Parse PRD files
      id: parse-prd
      run: |
        echo "é–‹å§‹åˆ†æ PRD æ–‡ä»¶..."
        
        # å»ºç«‹è‡¨æ™‚ç›®éŒ„
        mkdir -p temp
        
        # åˆ†æ PRD æ–‡ä»¶ç‹€æ…‹
        python3 .github/scripts/parse_prd_status.py
        
        # è®€å–åˆ†æçµæœ
        if [ -f temp/prd_status.json ]; then
          echo "status=$(cat temp/prd_status.json)" >> $GITHUB_OUTPUT
        else
          echo "status={\"error\": \"ç„¡æ³•è§£æ PRD ç‹€æ…‹\"}" >> $GITHUB_OUTPUT
        fi
        
        if [ -f temp/fr_ids.json ]; then
          echo "fr-ids=$(cat temp/fr_ids.json)" >> $GITHUB_OUTPUT
        else
          echo "fr-ids=[]" >> $GITHUB_OUTPUT
        fi

  check-code-status:
    name: æª¢æŸ¥ç¨‹å¼ç¢¼ç‹€æ…‹
    runs-on: ubuntu-latest
    outputs:
      code-status: ${{ steps.check-code.outputs.status }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check code repository status
      id: check-code
      run: |
        echo "æª¢æŸ¥ç¨‹å¼ç¢¼ç‹€æ…‹..."
        
        # æª¢æŸ¥å„æ¨¡çµ„è³‡æ–™å¤¾æ˜¯å¦æœ‰ç¨‹å¼ç¢¼
        python3 .github/scripts/check_code_status.py
        
        if [ -f temp/code_status.json ]; then
          echo "status=$(cat temp/code_status.json)" >> $GITHUB_OUTPUT
        else
          echo "status={\"error\": \"ç„¡æ³•æª¢æŸ¥ç¨‹å¼ç¢¼ç‹€æ…‹\"}" >> $GITHUB_OUTPUT
        fi

  run-tests:
    name: åŸ·è¡Œæ¸¬è©¦ä¸¦æª¢æŸ¥è¦†è“‹ç‡
    runs-on: ubuntu-latest
    outputs:
      test-coverage: ${{ steps.test-coverage.outputs.coverage }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm install
        npm install -g jest
    
    - name: Run tests and check coverage
      id: test-coverage
      run: |
        echo "åŸ·è¡Œæ¸¬è©¦ä¸¦æª¢æŸ¥è¦†è“‹ç‡..."
        
        # åŸ·è¡Œæ¸¬è©¦
        python3 .github/scripts/run_tests.py
        
        if [ -f temp/test_coverage.json ]; then
          echo "coverage=$(cat temp/test_coverage.json)" >> $GITHUB_OUTPUT
        else
          echo "coverage={\"unit\": 0, \"integration\": 0}" >> $GITHUB_OUTPUT
        fi

  check-issues:
    name: æª¢æŸ¥éŒ¯èª¤è¿½è¹¤
    runs-on: ubuntu-latest
    outputs:
      issue-status: ${{ steps.check-issues.outputs.status }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check GitHub Issues
      id: check-issues
      run: |
        echo "æª¢æŸ¥ GitHub Issues..."
        
        # æª¢æŸ¥ GitHub Issues ç‹€æ…‹
        python3 .github/scripts/check_issues.py
        
        if [ -f temp/issue_status.json ]; then
          echo "status=$(cat temp/issue_status.json)" >> $GITHUB_OUTPUT
        else
          echo "status={\"open_issues\": 0, \"closed_issues\": 0}" >> $GITHUB_OUTPUT
        fi

  update-mpm:
    name: æ›´æ–° MPM æ–‡ä»¶
    runs-on: ubuntu-latest
    needs: [analyze-prd, check-code-status, run-tests, check-issues]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Python dependencies
      run: |
        pip install jinja2 pyyaml requests
    
    - name: Update MPM
      run: |
        echo "æ›´æ–° MPM æ–‡ä»¶..."
        
        # æ›´æ–° MPM æ–‡ä»¶
        python3 .github/scripts/update_mpm.py \
          --prd-status '${{ needs.analyze-prd.outputs.prd-status }}' \
          --code-status '${{ needs.check-code-status.outputs.code-status }}' \
          --test-coverage '${{ needs.run-tests.outputs.test-coverage }}' \
          --issue-status '${{ needs.check-issues.outputs.issue-status }}'
    
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add docs/TOC_Module_Progress_Matrix.md
        git commit -m "ğŸ¤– Auto-update MPM: $(date)" || echo "No changes to commit"
        git push

  validate-consistency:
    name: é©—è­‰ä¸€è‡´æ€§
    runs-on: ubuntu-latest
    needs: [analyze-prd, check-code-status, run-tests, check-issues]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Validate consistency
      run: |
        echo "é©—è­‰æ–‡ä»¶èˆ‡ç¨‹å¼ç¢¼ä¸€è‡´æ€§..."
        
        # é©—è­‰ FR-ID èˆ‡æ¸¬è©¦æª”æ¡ˆçš„ä¸€è‡´æ€§
        python3 .github/scripts/validate_consistency.py \
          --fr-ids '${{ needs.analyze-prd.outputs.fr-ids }}' \
          --test-coverage '${{ needs.run-tests.outputs.test-coverage }}'
    
    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          if (fs.existsSync('temp/validation_report.md')) {
            const report = fs.readFileSync('temp/validation_report.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ” ä¸€è‡´æ€§é©—è­‰å ±å‘Š\n\n${report}`
            });
          }

  generate-dashboard:
    name: ç”Ÿæˆå¯è¦–åŒ–å„€è¡¨æ¿
    runs-on: ubuntu-latest
    needs: [update-mpm]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install matplotlib seaborn plotly
    
    - name: Generate dashboard
      run: |
        echo "ç”Ÿæˆå¯è¦–åŒ–å„€è¡¨æ¿..."
        
        # ç”Ÿæˆé€²åº¦åœ–è¡¨
        python3 .github/scripts/generate_dashboard.py
    
    - name: Upload dashboard artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mpm-dashboard
        path: docs/dashboard/
        retention-days: 30 